<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рейсы</title>
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="auth-links">
        {% if user.is_authenticated %}
        <p>Привет, {{ user.username }}!
            <a href="{% url 'travels:profile' %}">Личный кабинет</a> |
            <form method="POST" action="{% url 'travels:logout' %}" class="logout-form-inline">
                {% csrf_token %}
                <button type="submit" class="link-button">Выйти</button>
            </form>
        </p>
        {% else %}
        <p><a href="{% url 'travels:login' %}">Войти</a> | <a href="{% url 'travels:register' %}">Регистрация</a></p>
        {% endif %}
    </div>
    <div id="flights-container">
        <div class="max-w-4xl mx-auto p-4">
            <h1 class="text-2xl font-bold mb-4">Рейсы</h1>
            <p>Загрузка рейсов...</p>
        </div>
    </div>
    <a href="{% url 'travels:index' %}" class="btn">На главную</a>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function Flights() {
            const [flights, setFlights] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [participants, setParticipants] = useState(1);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const flightsPerPage = 5;

            // Parse URL parameters
            const params = new URLSearchParams(window.location.search);
            const fromCity = params.get('from_city') || '';
            const toCity = params.get('to_city') || '';
            const departDate = params.get('depart_date') || '';
            const directFlights = params.get('direct_flights') === 'true';
            const budget = params.get('budget') || '';

            // Get CSRF token from cookie
            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            };

            // Check authentication
            useEffect(() => {
                fetch('/api/get_cities/', { credentials: 'include' })
                    .then(response => {
                        setIsAuthenticated(response.ok);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Auth check error:', err);
                        setIsAuthenticated(false);
                        setLoading(false);
                    });
            }, []);

            // Fetch flights
            useEffect(() => {
                if (!fromCity || !toCity || !departDate) {
                    setError('Заполните все поля поиска');
                    setLoading(false);
                    return;
                }
                setLoading(true);
                const query = new URLSearchParams({
                    from_city: fromCity,
                    to_city: toCity,
                    depart_date: departDate,
                    direct_flights: directFlights,
                    budget: budget
                }).toString();
                fetch(`/api/search_flights/?${query}`, { credentials: 'include' })
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка загрузки рейсов');
                        return response.json();
                    })
                    .then(data => {
                        console.log('Flights data:', data); // Debug log
                        setFlights(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Error fetching flights:', err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, [fromCity, toCity, departDate, directFlights, budget]);

            // Pagination
            const indexOfLastFlight = currentPage * flightsPerPage;
            const indexOfFirstFlight = indexOfLastFlight - flightsPerPage;
            const currentFlights = flights.slice(indexOfFirstFlight, indexOfLastFlight);
            const totalPages = Math.ceil(flights.length / flightsPerPage);

            const paginate = (pageNumber) => setCurrentPage(pageNumber);

            if (loading) {
                return <div className="max-w-4xl mx-auto p-4"><p>Загрузка рейсов...</p></div>;
            }

            if (error) {
                return <div className="max-w-4xl mx-auto p-4"><p className="text-red-500">Ошибка: {error}</p></div>;
            }

            return (
                <div className="max-w-4xl mx-auto p-4">
                    <h1 className="text-2xl font-bold mb-4">Рейсы</h1>
                    <div className="mb-4">
                        <label className="block mb-1">Путешественники</label>
                        <input
                            type="number"
                            value={participants}
                            onChange={(e) => setParticipants(parseInt(e.target.value) || 1)}
                            className="w-full p-2 border rounded"
                            min="1"
                        />
                    </div>
                    {currentFlights.length === 0 ? (
                        <p>Рейсы не найдены.</p>
                    ) : (
                        <div className="space-y-4">
                            {currentFlights.map(flight => (
                                <div key={flight.id} className="border rounded p-4">
                                    <h3 className="text-lg font-semibold">{flight.airline}: {flight.from_city} → {flight.to_city}</h3>
                                    <p>Вылет: {new Date(flight.departure_time).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}</p>
                                    <p>Прибытие: {new Date(flight.arrival_time).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}</p>
                                    <p>Цена: {flight.price} ₽</p>
                                    <p>Продолжительность: {flight.duration}</p>
                                    <p>{flight.direct ? 'Прямой' : 'С пересадкой'}</p>
                                    {isAuthenticated ? (
                                        <form method="POST" action="/flights/">
                                            <input type="hidden" name="csrfmiddlewaretoken" value={getCookie('csrftoken')} />
                                            <input type="hidden" name="flight_id" value={flight.id} />
                                            <input type="hidden" name="participants" value={participants} />
                                            <button
                                                type="submit"
                                                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mt-2"
                                            >
                                                Забронировать
                                            </button>
                                        </form>
                                    ) : (
                                        <a href="/login/" className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mt-2 inline-block">
                                            Войти для бронирования
                                        </a>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                    {totalPages > 1 && (
                        <div className="flex justify-center gap-2 mt-4">
                            {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                                <button
                                    key={page}
                                    onClick={() => paginate(page)}
                                    className={`px-4 py-2 rounded ${currentPage === page ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                                >
                                    {page}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<Flights />, document.getElementById('flights-container'));
    </script>
</body>
</html>